import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';

export type Language = 'en' | 'ta';

export interface LanguageConfig {
    code: Language;
    name: string;
    nativeName: string;
    flag: string;
    rtl: boolean;
}

@Injectable({
    providedIn: 'root'
})
export class LanguageService {
    private currentLanguageSubject = new BehaviorSubject<Language>('en');
    public currentLanguage$ = this.currentLanguageSubject.asObservable();

    private readonly STORAGE_KEY = 'preferred_language';

    // Available languages
    public readonly languages: LanguageConfig[] = [
        {
            code: 'en',
            name: 'English',
            nativeName: 'English',
            flag: 'ЁЯЗ║ЁЯЗ╕',
            rtl: false
        },
        {
            code: 'ta',
            name: 'Tamil',
            nativeName: 'родрооро┐ро┤рпН',
            flag: 'ЁЯЗоЁЯЗ│',
            rtl: false
        }
    ];

    // Basic translations for UI elements
    private translations: Record<Language, Record<string, string>> = {
        en: {
            // Navigation
            'nav.dashboard': 'Dashboard',
            'nav.quiz': 'Quiz',
            'nav.mockTest': 'Mock Test',
            'nav.leaderboard': 'Leaderboard',
            'nav.chat': 'AI Chat',
            'nav.analytics': 'Analytics',
            'nav.profile': 'Profile',
            'nav.logout': 'Logout',

            // Common
            'common.loading': 'Loading...',
            'common.submit': 'Submit',
            'common.cancel': 'Cancel',
            'common.save': 'Save',
            'common.delete': 'Delete',
            'common.edit': 'Edit',
            'common.view': 'View',
            'common.close': 'Close',
            'common.back': 'Back',
            'common.next': 'Next',
            'common.previous': 'Previous',
            'common.search': 'Search',
            'common.filter': 'Filter',
            'common.sort': 'Sort',
            'common.score': 'Score',
            'common.time': 'Time',
            'common.questions': 'Questions',
            'common.answers': 'Answers',
            'common.correct': 'Correct',
            'common.incorrect': 'Incorrect',
            'common.unanswered': 'Unanswered',

            // Authentication
            'auth.login': 'Login',
            'auth.register': 'Register',
            'auth.email': 'Email',
            'auth.password': 'Password',
            'auth.firstName': 'First Name',
            'auth.lastName': 'Last Name',
            'auth.phoneNumber': 'Phone Number',
            'auth.confirmPassword': 'Confirm Password',
            'auth.forgotPassword': 'Forgot Password?',
            'auth.rememberMe': 'Remember Me',
            'auth.loginSuccess': 'Login successful!',
            'auth.registerSuccess': 'Registration successful!',

            // Quiz
            'quiz.selectSubject': 'Select Subject',
            'quiz.difficulty': 'Difficulty',
            'quiz.language': 'Language',
            'quiz.timeLimit': 'Time Limit',
            'quiz.questionCount': 'Number of Questions',
            'quiz.startQuiz': 'Start Quiz',
            'quiz.submitQuiz': 'Submit Quiz',
            'quiz.timeRemaining': 'Time Remaining',
            'quiz.questionNumber': 'Question',
            'quiz.of': 'of',
            'quiz.nextQuestion': 'Next Question',
            'quiz.previousQuestion': 'Previous Question',
            'quiz.reviewAnswers': 'Review Answers',
            'quiz.submitConfirm': 'Are you sure you want to submit the quiz?',

            // Mock Test
            'mockTest.title': 'Mock Test',
            'mockTest.description': '100 questions from all subjects',
            'mockTest.timeLimit': '2 hours',
            'mockTest.start': 'Start Mock Test',
            'mockTest.progress': 'Progress',
            'mockTest.timeRemaining': 'Time Remaining',
            'mockTest.submitTest': 'Submit Test',

            // Results
            'results.congratulations': 'Congratulations!',
            'results.yourScore': 'Your Score',
            'results.correctAnswers': 'Correct Answers',
            'results.wrongAnswers': 'Wrong Answers',
            'results.unansweredQuestions': 'Unanswered Questions',
            'results.timeTaken': 'Time Taken',
            'results.percentage': 'Percentage',
            'results.grade': 'Grade',
            'results.viewDetails': 'View Details',
            'results.retakeQuiz': 'Retake Quiz',

            // Leaderboard
            'leaderboard.title': 'Leaderboard',
            'leaderboard.rank': 'Rank',
            'leaderboard.name': 'Name',
            'leaderboard.score': 'Score',
            'leaderboard.attempts': 'Attempts',
            'leaderboard.global': 'Global Ranking',
            'leaderboard.subject': 'Subject Wise',

            // Chat
            'chat.title': 'AI Assistant',
            'chat.placeholder': 'Ask me about exam preparation...',
            'chat.send': 'Send',
            'chat.typing': 'AI is typing...',
            'chat.suggestedQuestions': 'Suggested Questions',

            // Subjects
            'subjects.tamilSubject': 'Tamil Subject',
            'subjects.tamilGrammar': 'Tamil Grammar',
            'subjects.simplification': 'Simplification',
            'subjects.percentage': 'Percentage',
            'subjects.hcfLcm': 'HCF and LCM',
            'subjects.ratioProportionTitle': 'Ratio and Proportion',
            'subjects.areaVolume': 'Area and Volume',
            'subjects.generalScience': 'General Science',
            'subjects.currentEvents': 'Current Events',
            'subjects.geography': 'Geography',
            'subjects.historyCulture': 'History and Culture',
            'subjects.indianPolity': 'Indian Polity'
        },
        ta: {
            // Navigation
            'nav.dashboard': 'роорпБроХрокрпНрокрпБ',
            'nav.quiz': 'ро╡ро┐ройро╛роЯро┐ ро╡ро┐ройро╛',
            'nav.mockTest': 'рооро╛родро┐ро░ро┐ родрпЗро░рпНро╡рпБ',
            'nav.leaderboard': 'родро▓рпИроорпИ рокро▓роХрпИ',
            'nav.chat': 'AI роЙро░рпИропро╛роЯро▓рпН',
            'nav.analytics': 'рокроХрпБрокрпНрокро╛ропрпНро╡рпБ',
            'nav.profile': 'роЪрпБропро╡ро┐ро╡ро░роорпН',
            'nav.logout': 'ро╡рпЖро│ро┐ропрпЗро▒рпБ',

            // Common
            'common.loading': 'роПро▒рпНро▒рпБроХро┐ро▒родрпБ...',
            'common.submit': 'роЪрооро░рпНрокрпНрокро┐роХрпНроХро╡рпБроорпН',
            'common.cancel': 'ро░родрпНродрпБ роЪрпЖропрпНропро╡рпБроорпН',
            'common.save': 'роЪрпЗрооро┐роХрпНроХро╡рпБроорпН',
            'common.delete': 'роирпАроХрпНроХро╡рпБроорпН',
            'common.edit': 'родро┐ро░рпБродрпНродро╡рпБроорпН',
            'common.view': 'роХро╛рогрпНроХ',
            'common.close': 'роорпВроЯрпБ',
            'common.back': 'рокро┐ройрпН',
            'common.next': 'роЕроЯрпБродрпНродрпБ',
            'common.previous': 'роорпБроирпНродрпИроп',
            'common.search': 'родрпЗроЯрпБ',
            'common.filter': 'ро╡роЯро┐роХроЯрпНроЯро┐',
            'common.sort': 'ро╡ро░ро┐роЪрпИрокрпНрокроЯрпБродрпНродрпБ',
            'common.score': 'роородро┐рокрпНрокрпЖрогрпН',
            'common.time': 'роирпЗро░роорпН',
            'common.questions': 'роХрпЗро│рпНро╡ро┐роХро│рпН',
            'common.answers': 'рокродро┐ро▓рпНроХро│рпН',
            'common.correct': 'роЪро░ро┐ропро╛рой',
            'common.incorrect': 'родро╡ро▒ро╛рой',
            'common.unanswered': 'рокродро┐ро▓ро│ро┐роХрпНроХро╛род',

            // Authentication
            'auth.login': 'роЙро│рпНроирпБро┤рпИроп',
            'auth.register': 'рокродро┐ро╡рпБ роЪрпЖропрпНроп',
            'auth.email': 'рооро┐ройрпНройроЮрпНроЪро▓рпН',
            'auth.password': 'роХроЯро╡рпБроЪрпНроЪрпКро▓рпН',
            'auth.firstName': 'роорпБродро▓рпН рокрпЖропро░рпН',
            'auth.lastName': 'роХроЯрпИроЪро┐ рокрпЖропро░рпН',
            'auth.phoneNumber': 'родрпКро▓рпИрокрпЗроЪро┐ роОрогрпН',
            'auth.confirmPassword': 'роХроЯро╡рпБроЪрпНроЪрпКро▓рпНро▓рпИ роЙро▒рпБродро┐рокрпНрокроЯрпБродрпНродро╡рпБроорпН',
            'auth.forgotPassword': 'роХроЯро╡рпБроЪрпНроЪрпКро▓рпНро▓рпИ рооро▒роирпНродрпБро╡ро┐роЯрпНроЯрпАро░рпНроХро│ро╛?',
            'auth.rememberMe': 'роОройрпНройрпИ роиро┐ройрпИро╡ро┐ро▓рпН ро╡рпИродрпНродрпБроХрпНроХрпКро│рпНро│рпБроЩрпНроХро│рпН',
            'auth.loginSuccess': 'роЙро│рпНроирпБро┤рпИро╡рпБ ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ!',
            'auth.registerSuccess': 'рокродро┐ро╡рпБ ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ!',

            // Quiz
            'quiz.selectSubject': 'рокро╛роЯродрпНродрпИ родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН',
            'quiz.difficulty': 'роЪро┐ро░роороорпН',
            'quiz.language': 'роорпКро┤ро┐',
            'quiz.timeLimit': 'роирпЗро░ ро╡ро░роорпНрокрпБ',
            'quiz.questionCount': 'роХрпЗро│рпНро╡ро┐роХро│ро┐ройрпН роОрогрпНрогро┐роХрпНроХрпИ',
            'quiz.startQuiz': 'ро╡ро┐ройро╛роЯро┐ ро╡ро┐ройро╛ро╡рпИ родрпКроЯроЩрпНроХрпБ',
            'quiz.submitQuiz': 'ро╡ро┐ройро╛роЯро┐ ро╡ро┐ройро╛ро╡рпИ роЪрооро░рпНрокрпНрокро┐роХрпНроХро╡рпБроорпН',
            'quiz.timeRemaining': 'роорпАродроорпБро│рпНро│ роирпЗро░роорпН',
            'quiz.questionNumber': 'роХрпЗро│рпНро╡ро┐',
            'quiz.of': 'роЗро▓рпН',
            'quiz.nextQuestion': 'роЕроЯрпБродрпНрод роХрпЗро│рпНро╡ро┐',
            'quiz.previousQuestion': 'роорпБроирпНродрпИроп роХрпЗро│рпНро╡ро┐',
            'quiz.reviewAnswers': 'рокродро┐ро▓рпНроХро│рпИ роородро┐рокрпНрокро┐роЯро╡рпБроорпН',
            'quiz.submitConfirm': 'роирпАроЩрпНроХро│рпН роиро┐роЪрпНроЪропрооро╛роХ ро╡ро┐ройро╛роЯро┐ ро╡ро┐ройро╛ро╡рпИ роЪрооро░рпНрокрпНрокро┐роХрпНроХ ро╡ро┐ро░рпБроорпНрокрпБроХро┐ро▒рпАро░рпНроХро│ро╛?',

            // Mock Test
            'mockTest.title': 'рооро╛родро┐ро░ро┐ родрпЗро░рпНро╡рпБ',
            'mockTest.description': 'роЕройрпИродрпНродрпБ рокро╛роЯроЩрпНроХро│ро┐ро▓ро┐ро░рпБроирпНродрпБроорпН 100 роХрпЗро│рпНро╡ро┐роХро│рпН',
            'mockTest.timeLimit': '2 роорогро┐ роирпЗро░роорпН',
            'mockTest.start': 'рооро╛родро┐ро░ро┐ родрпЗро░рпНро╡рпИ родрпКроЯроЩрпНроХрпБ',
            'mockTest.progress': 'роорпБройрпНройрпЗро▒рпНро▒роорпН',
            'mockTest.timeRemaining': 'роорпАродроорпБро│рпНро│ роирпЗро░роорпН',
            'mockTest.submitTest': 'родрпЗро░рпНро╡рпИ роЪрооро░рпНрокрпНрокро┐роХрпНроХро╡рпБроорпН',

            // Results
            'results.congratulations': 'ро╡ро╛ро┤рпНродрпНродрпБроХрпНроХро│рпН!',
            'results.yourScore': 'роЙроЩрпНроХро│рпН роородро┐рокрпНрокрпЖрогрпН',
            'results.correctAnswers': 'роЪро░ро┐ропро╛рой рокродро┐ро▓рпНроХро│рпН',
            'results.wrongAnswers': 'родро╡ро▒ро╛рой рокродро┐ро▓рпНроХро│рпН',
            'results.unansweredQuestions': 'рокродро┐ро▓ро│ро┐роХрпНроХро╛род роХрпЗро│рпНро╡ро┐роХро│рпН',
            'results.timeTaken': 'роОроЯрпБродрпНрод роирпЗро░роорпН',
            'results.percentage': 'роЪродро╡рпАродроорпН',
            'results.grade': 'родро░роорпН',
            'results.viewDetails': 'ро╡ро┐ро╡ро░роЩрпНроХро│рпИ роХро╛рогрпНроХ',
            'results.retakeQuiz': 'роорпАрогрпНроЯрпБроорпН ро╡ро┐ройро╛роЯро┐ ро╡ро┐ройро╛',

            // Leaderboard
            'leaderboard.title': 'родро▓рпИроорпИ рокро▓роХрпИ',
            'leaderboard.rank': 'родро░ро╡ро░ро┐роЪрпИ',
            'leaderboard.name': 'рокрпЖропро░рпН',
            'leaderboard.score': 'роородро┐рокрпНрокрпЖрогрпН',
            'leaderboard.attempts': 'роорпБропро▒рпНроЪро┐роХро│рпН',
            'leaderboard.global': 'роЙро▓роХро│ро╛ро╡ро┐роп родро░ро╡ро░ро┐роЪрпИ',
            'leaderboard.subject': 'рокро╛роЯроорпН ро╡ро╛ро░ро┐ропро╛роХ',

            // Chat
            'chat.title': 'AI роЙродро╡ро┐ропро╛ро│ро░рпН',
            'chat.placeholder': 'родрпЗро░рпНро╡рпБ родропро╛ро░ро┐рокрпНрокрпИрокрпН рокро▒рпНро▒ро┐ роОройрпНройро┐роЯроорпН роХрпЗро│рпБроЩрпНроХро│рпН...',
            'chat.send': 'роЕройрпБрокрпНрокрпБ',
            'chat.typing': 'AI родроЯрпНроЯроЪрпНроЪрпБ роЪрпЖропрпНроХро┐ро▒родрпБ...',
            'chat.suggestedQuestions': 'рокро░ро┐роирпНродрпБро░рпИроХрпНроХрокрпНрокроЯрпНроЯ роХрпЗро│рпНро╡ро┐роХро│рпН',

            // Subjects
            'subjects.tamilSubject': 'родрооро┐ро┤рпН рокро╛роЯроорпН',
            'subjects.tamilGrammar': 'родрооро┐ро┤рпН роЗро▓роХрпНроХрогроорпН',
            'subjects.simplification': 'роОро│ро┐роорпИрокрпНрокроЯрпБродрпНродро▓рпН',
            'subjects.percentage': 'роЪродро╡рпАродроорпН',
            'subjects.hcfLcm': 'роороХро╛.роЪро╛роо. рооро▒рпНро▒рпБроорпН роХрогро┐.роороХро╛.',
            'subjects.ratioProportionTitle': 'ро╡ро┐роХро┐родроорпН рооро▒рпНро▒рпБроорпН ро╡ро┐роХро┐родро╛роЪрпНроЪро╛ро░роорпН',
            'subjects.areaVolume': 'рокро░рокрпНрокро│ро╡рпБ рооро▒рпНро▒рпБроорпН роХрой роЕро│ро╡рпБ',
            'subjects.generalScience': 'рокрпКродрпБ роЕро▒ро┐ро╡ро┐ропро▓рпН',
            'subjects.currentEvents': 'роироЯрокрпНрокрпБ роиро┐роХро┤рпНро╡рпБроХро│рпН',
            'subjects.geography': 'рокрпБро╡ро┐ропро┐ропро▓рпН',
            'subjects.historyCulture': 'ро╡ро░ро▓ро╛ро▒рпБ рооро▒рпНро▒рпБроорпН рокрогрпНрокро╛роЯрпБ',
            'subjects.indianPolity': 'роЗроирпНродро┐роп роЕро░роЪро┐ропро▓рпН'
        }
    };

    constructor() {
        this.initializeLanguage();
    }

    private initializeLanguage(): void {
        const savedLanguage = localStorage.getItem(this.STORAGE_KEY) as Language;
        if (savedLanguage && this.isValidLanguage(savedLanguage)) {
            this.currentLanguageSubject.next(savedLanguage);
        } else {
            // Default to English if no saved preference or invalid language
            this.setLanguage('en');
        }
    }

    setLanguage(language: Language): void {
        if (this.isValidLanguage(language)) {
            this.currentLanguageSubject.next(language);
            localStorage.setItem(this.STORAGE_KEY, language);

            // Update document language attribute
            document.documentElement.lang = language;

            // Set direction for RTL languages (if needed in future)
            const config = this.getLanguageConfig(language);
            document.documentElement.dir = config?.rtl ? 'rtl' : 'ltr';
        }
    }

    getCurrentLanguage(): Language {
        return this.currentLanguageSubject.value;
    }

    getLanguageConfig(language: Language): LanguageConfig | undefined {
        return this.languages.find(lang => lang.code === language);
    }

    translate(key: string, language?: Language): string {
        const lang = language || this.getCurrentLanguage();
        return this.translations[lang]?.[key] || key;
    }

    // Get all translations for current language
    getTranslations(language?: Language): Record<string, string> {
        const lang = language || this.getCurrentLanguage();
        return this.translations[lang] || {};
    }

    private isValidLanguage(language: string): language is Language {
        return this.languages.some(lang => lang.code === language);
    }

    // Helper method to get translated subject names
    getSubjectTranslations(): Record<string, string> {
        const currentLang = this.getCurrentLanguage();
        return {
            'Tamil Subject Quiz': this.translate('subjects.tamilSubject', currentLang),
            'Tamil Grammar': this.translate('subjects.tamilGrammar', currentLang),
            'Simplification': this.translate('subjects.simplification', currentLang),
            'Percentage': this.translate('subjects.percentage', currentLang),
            'HCF and LCM': this.translate('subjects.hcfLcm', currentLang),
            'Ratio and Proportion': this.translate('subjects.ratioProportionTitle', currentLang),
            'Area and Volume': this.translate('subjects.areaVolume', currentLang),
            'General Science': this.translate('subjects.generalScience', currentLang),
            'Current Events': this.translate('subjects.currentEvents', currentLang),
            'Geography': this.translate('subjects.geography', currentLang),
            'History and Culture': this.translate('subjects.historyCulture', currentLang),
            'Indian Polity': this.translate('subjects.indianPolity', currentLang)
        };
    }
} 